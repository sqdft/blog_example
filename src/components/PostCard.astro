 ---
import path from "node:path";
import type { CollectionEntry } from "astro:content";
import { Icon } from "astro-icon/components";

import { getDir } from "../utils/url-utils";
import PostMetadata from "./PostMeta.astro";
import ImageWrapper from "./misc/ImageWrapper.astro";

interface Props {
	class?: string;
	entry: CollectionEntry<"posts">;
	title: string;
	url: string;
	published: Date;
	updated?: Date;
	tags: string[];
	image: string;
	description: string;
	draft: boolean;
	style: string;
	isLCP?: boolean;
}
const {
	entry,
	title,
	url,
	published,
	updated,
	tags,
	image,
	description,
	style,
	isLCP = false,
} = Astro.props;

const isPinned = entry.data.pinned === true;
const className = Astro.props.class;

const hasCover = image !== undefined && image !== null && image !== "";

const coverWidth = "28%";

const { remarkPluginFrontmatter } = await entry.render();
---
<div id={`post-card-${entry.slug}`} data-slug={entry.slug} data-published={published.getTime()} data-updated={updated?.getTime() || published.getTime()} data-pinned={isPinned} class:list={["card-base flex flex-col-reverse md:flex-col w-full rounded-[var(--radius-large)] overflow-hidden relative group", className]} style={style}>
    <div class:list={["pl-6 md:pl-9 pr-6 md:pr-20 pt-3 md:pt-4 pb-3 relative z-10 w-full"]}>
        <a href={url}
           class="transition-colors duration-300 group-hover:text-[var(--primary)] w-full block font-bold mb-1.5 text-lg text-90
        dark:text-white/90
        active:text-[var(--title-active)] dark:active:text-[var(--title-active)]
        before:w-1 before:h-4 before:rounded-md before:bg-[var(--primary)]
        before:absolute before:top-[22px] before:left-[18px] before:hidden md:before:block
        ">
            {isPinned && (
                <div class="inline-flex items-center gap-1 align-middle mr-2 px-2 py-1 rounded-md
                    bg-[var(--primary)] text-white text-sm font-bold shadow-sm
                    transform -translate-y-1">
                    <Icon name="material-symbols:push-pin" class="text-sm transform rotate-45" />
                    <span>置顶</span>
                </div>
            )}
            {title}
            <Icon class="inline text-lg text-[var(--primary)] md:hidden translate-y-0.5 ml-2" name="material-symbols:chevron-right-rounded" ></Icon>
            <Icon class="text-[var(--primary)] text-xl transition-all duration-300 hidden md:inline absolute translate-y-0.5 opacity-0 group-hover:opacity-100 -translate-x-2 group-hover:translate-x-0" name="material-symbols:chevron-right-rounded"></Icon>
        </a>

        <!-- metadata -->
        <PostMetadata published={published} updated={updated} tags={tags} hideTagsForMobile={true} hideUpdateDate={false} class="mb-3"></PostMetadata>

        <!-- description -->
        <div class:list={["transition text-sm mb-2 pr-4 text-black/70 dark:text-white/70", {"line-clamp-2": !description}]}>
            { description || remarkPluginFrontmatter.excerpt }
        </div>

        <!-- word count, read time and page views -->
        <div class="text-sm text-black/40 dark:text-white/40 flex gap-2 transition items-center flex-wrap mt-1.5">
            <div class="flex items-center gap-2 px-2 py-1 rounded-lg bg-[var(--btn-regular-bg)]/50 backdrop-blur-sm border border-[var(--line-divider)]">
                <Icon name="material-symbols:notes-rounded" class="text-sm text-[var(--primary)] opacity-90"></Icon>
                <span class="text-xs">{remarkPluginFrontmatter.words} 字</span>
            </div>
            <div class="flex items-center gap-2 px-2 py-1 rounded-lg bg-[var(--btn-regular-bg)]/50 backdrop-blur-sm border border-[var(--line-divider)]">
                <Icon name="material-symbols:schedule-outline-rounded" class="text-sm text-[var(--primary)] opacity-90"></Icon>
                <span class="text-xs">{remarkPluginFrontmatter.minutes} 分钟</span>
            </div>
            <div class="flex items-center gap-2 px-2 py-1 rounded-lg bg-[var(--btn-regular-bg)]/50 backdrop-blur-sm border border-[var(--line-divider)]">
                <Icon name="material-symbols:visibility-outline-rounded" class="text-sm text-[var(--primary)] opacity-90"></Icon>
                <span class="text-xs article-view-count" data-article-id={entry.slug}>-</span>
                <span class="text-xs">阅读</span>
            </div>
            <div class="flex items-center gap-2 px-2 py-1 rounded-lg bg-[var(--btn-regular-bg)]/50 backdrop-blur-sm border border-[var(--line-divider)]">
                <Icon name="material-symbols:person-outline-rounded" class="text-sm text-[var(--primary)] opacity-90"></Icon>
                <span class="text-xs article-visitor-count" data-article-id={entry.slug}>-</span>
                <span class="text-xs">访客</span>
            </div>
            </div>
        </div>

    </div>

    {hasCover && <a href={url} aria-label={title}
                    class:list={["group/cover",
                        "max-h-[16vh] md:max-h-none mx-4 mt-3 -mb-1.5 md:mb-0 md:mx-0 md:mt-0",
                        "md:w-[var(--coverWidth)] relative md:absolute md:top-2.5 md:bottom-2.5 md:right-[4.5rem] rounded-xl overflow-hidden active:scale-95 transition-transform duration-300",
                        "tilt-card" // Added for 3D tilt effect
                    ]} >
        <div class="absolute pointer-events-none z-10 w-full h-full group-hover/cover:bg-black/30 group-active/cover:bg-black/50 transition-colors duration-300"></div>
        <ImageWrapper src={image} basePath={path.join("content/posts/", getDir(entry.id))} alt={title}
                  class="w-full h-full object-cover transition-transform duration-700 group-hover/cover:scale-110" isLCP={isLCP}>
        </ImageWrapper>
    </a>}

    <!-- 右侧图片+箭头按钮 - 跟随内容高度 -->
    <div class="!hidden md:!flex absolute right-3 top-2.5 bottom-2.5 w-[3.25rem] items-center">
        <a href={url} aria-label={title} class="w-full h-[3.25rem] rounded-xl bg-[var(--enter-btn-bg)]
         hover:bg-[var(--enter-btn-bg-hover)] active:bg-[var(--enter-btn-bg-active)] active:scale-95
         border border-[var(--line-divider)] overflow-hidden flex items-center justify-center
        ">
            <div class="relative w-full h-full flex items-center justify-center">
                <img 
                    src="https://g.gtimg.cn/music/photo_new/T053XD010017SNjl46uSEf.jpg" 
                    alt="点击阅读"
                    class="absolute inset-0 w-full h-full object-cover opacity-60"
                />
                <Icon name="material-symbols:chevron-right-rounded"
                      class="relative z-10 text-white text-2xl drop-shadow-lg">
                </Icon>
            </div>
        </a>
    </div>
</div>
<div class="transition border-t-[1px] border-dashed mx-6 border-black/10 dark:border-white/[0.15] last:border-t-0 md:hidden"></div>

<script define:vars={{ entry }}>
    // 3D 悬浮视差效果
    function initTiltEffect() {
        const card = document.getElementById(`post-card-${entry.slug}`);
        if (!card) return;

        const tiltElement = card.querySelector('.tilt-card');
        if (!tiltElement) return;

        let frameId;
        const handleMouseMove = (e) => {
            if (frameId) cancelAnimationFrame(frameId);

            frameId = requestAnimationFrame(() => {
                const rect = tiltElement.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                // 计算相对中心点的坐标 (-1 到 1)
                const centerX = rect.width / 2;
                const centerY = rect.height / 2;
                
                const rotateX = ((y - centerY) / centerY) * -8; // 最大旋转角度 -8 到 8
                const rotateY = ((x - centerX) / centerX) * 8;

                tiltElement.style.transform = `perspective(1000px) rotateX(${rotateX}deg) rotateY(${rotateY}deg) scale3d(1.02, 1.02, 1.02)`;
            });
        };

        const handleMouseLeave = () => {
             if (frameId) cancelAnimationFrame(frameId);
             tiltElement.style.transform = 'perspective(1000px) rotateX(0deg) rotateY(0deg) scale3d(1, 1, 1)';
        };

        tiltElement.addEventListener('mousemove', handleMouseMove);
        tiltElement.addEventListener('mouseleave', handleMouseLeave);
    }

    // 获取文章浏览量统计
    function updateStatsUI(slug, pageViews, visits) {
        const viewsElement = document.getElementById(`page-views-${slug}`);
        const visitsElement = document.getElementById(`page-visits-${slug}`);
        if (viewsElement) {
            viewsElement.textContent = pageViews.toString();
        }
        if (visitsElement) {
            visitsElement.textContent = visits.toString();
        }
    }

    // 页面加载完成后初始化效果
    function initPostCard() {
        // 初始化 3D 效果
        initTiltEffect();
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initPostCard);
    } else {
        initPostCard();
    }
</script>

<style define:vars={{coverWidth}}>
</style>